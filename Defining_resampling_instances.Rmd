---
title: "Predicting drug mode of action: Defining resampling instances"
author: "Florian Huber, Leonard Dubois"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Setup

```{r setup}
# function to check if a package is installed, if so, load it, else install and then load it
source("./R/ipak.R")
# set chunk options and load libraries
source("./setup.R")
# custom functions
# walk(list.files("./R", pattern = "*.R", full.names = T), source)

matrix_container <- readRDS("./data/programmatic_output/matrix_container.rds")
```


# Aim of notebook: defining sampling instances - motivation

In order to compare performances of different models (e.g. Random Forest, Boosting trees...), one 
has to use the *exact same samples in every fold* (inner and outer) of the nested cross-validation.

The function `mlr::makeResampleInstance()` could be used to keep in memory a object containing details 
on the sampling. For a 5-fold by 5-fold nested cross-validation, 6 resampling instances are needed: 
one for each inner fold and one for the outer loop. In particular, instances of the inner fold 
should be based on the training sets defined in the outer loop instances.

Even if such a strategy can't be avoided in order to obtain an unbiased comparison of models, it 
still presents some weaknesses : one can easily argue that the chosen instances are the ones giving 
the best performances. To prevent such criticism, a repeated cross validation is possible, e.g. 
10 times. 

Thus, the exact strategy for assessing models' performances and comparing them could be called: 
**Repeated nested cross-validation with instanced stratified resampling**


## Generating instances

Since we have a small data set, it is actually better to use more folds. Thus, the training set 
will contain more individuals. The testing set results can be concatenated afterwards, with each 
individual having been predicted by a model in which it was not trained. Functions are found in 
`cvinstance_generation.R` and test functions are found in `cvinstance_tests.R`. 'New' drugs 
refers to updated drug labels from 05/2018.

```{r making_nested_cvinst_onedosg}
Rep_Nest_CV_instance_newDrugs = list()

dataset_newDrugs <- readRDS("./data/programmatic_output/the_matrix_matrixcontainer_mostinteractions.rds")

dataset_newDrugs$process_broad <- 
   ifelse(dataset_newDrugs$process_broad %in% c("oxidative_stress", "pmf", "protein_qc"), 
          "other", 
          dataset_newDrugs$process_broad)

for(i in 1:10){
    name = paste0("NCV_", as.character(i))
    Rep_Nest_CV_instance_newDrugs[[name]] <- 
       instance_creation(dataset = dataset_newDrugs, printTest = FALSE)
}
```


### Expanding resampling instance to all dosages

The idea here is to copy the resampling object and map individuals IDs from the newDrug dataset to 
the drugs names and then remap the names to the individuals IDs of the allDosage dataset. One 
should also make the size fields in the lists match the length of vector of IDs. This is done in 
the mapping function `RepNCV_instance_map_drugname()`. 

Actual generation of nested cv instance for all dosages from the one with one dosage:

```{r making_nested_cvinst_alldosg}
dataset_allDosage = 
   filter(matrix_container, drug_dosages == "all") %>% 
   select(drug_feature_matrices) %>% 
   `[[`(1,1)

dataset_allDosage$process_broad <- 
   ifelse(dataset_allDosage$process_broad %in% c("oxidative_stress", "pmf", "protein_qc"), 
          "other", 
          dataset_allDosage$process_broad)

Rep_Nest_CV_instance_allDosage = Rep_Nest_CV_instance_newDrugs

Rep_Nest_CV_instance_allDosage = 
   RepNCV_instance_map_drugname(instance_oneDrug = Rep_Nest_CV_instance_newDrugs, 
                                dataset_oneDosage = dataset_newDrugs, 
                                dataset_allDosage = dataset_allDosage)
```


## Test functions

For each repeat, need to make sure that:
1. The number of indices corresponds to the number of observations.
2. Each drug ends up in the test set of the outer loop exactly once.
3. For each training test split of the outer loop only those drugs end up in the training set that 
are not in the test set. 
4. Observations that are just different dosages of the same drug should move together: both in 
the outer and in all the inner CV instances.
5. Stratification should be respected.

These functions are found in `cvinstance_generation.R`.

Running the actual tests:

```{r testing_cvinsts_I}
# we have two types of data frames in terms of number of samples: one with all dosages, one with 
# most interactions
# just keep the columns that we need
(the_matrix_all <- matrix_container$drug_feature_matrices[[3]][, 1:3])
(the_matrix_mostias <- matrix_container$drug_feature_matrices[[180]][, 1:3])

run_cv_tests(Rep_Nest_CV_instance_newDrugs, the_matrix_mostias)
run_cv_tests(Rep_Nest_CV_instance_allDosage, the_matrix_all)
```


We already have some nested cv instances - those that were used in the matrix_container:

```{r testing_cvinsts_II}
stopifnot(file.exists("./data/programmatic_output/Rep_Nest_CV_instance_newDrugs.RData") && 
             file.exists("./data/programmatic_output/Rep_Nest_CV_instance_allDosage.RData"))

oldname <- load("./data/programmatic_output/Rep_Nest_CV_instance_newDrugs.RData")
cvinst_mostias <- get(oldname)
rm(oldname)

oldname <- load("./data/programmatic_output/Rep_Nest_CV_instance_allDosage.RData")
cvinst_alldosg <- get(oldname)
rm(oldname)

run_cv_tests(cvinst_mostias, the_matrix_mostias)
run_cv_tests(cvinst_alldosg, the_matrix_all)

# these are indeed the cv instances used in matrix_container:
all(map_lgl(matrix_container$resamp_instance[matrix_container$drug_dosages == "most_interactions"], 
            ~identical(.x, cvinst_mostias)))
all(map_lgl(matrix_container$resamp_instance[matrix_container$drug_dosages == "all"], 
            ~identical(.x, cvinst_alldosg)))


# an example instance + data set
nest_cvinst <- cvinst_alldosg$NCV_1
data <- the_matrix_all

# something's strange, e.g. in the first split there is one observation for cell_wall 
# in the most interactions thing and 7 observations in the all dosages thing
# (even though the all dosage instance generation works by mapping ...)
cvtest_report_stratification(cvinst_alldosg$NCV_1, the_matrix_all)$outer
cvtest_report_stratification(cvinst_mostias$NCV_1, the_matrix_mostias)$outer

# to be more precise:
tab <- cvtest_report_stratification(cvinst_mostias$NCV_1, the_matrix_mostias, FALSE)$outer
filter(tab, test.or.train == "test", MoA == "cell_wall", split == "a")

# whereas
tab2 <- cvtest_report_stratification(cvinst_alldosg$NCV_1, the_matrix_all, FALSE)$outer
filter(tab2, test.or.train == "test", MoA == "cell_wall", split == "a")

# no idea why - since all the other tests are passed, however, I wouldn't change anything here now 
```


## Saving data

```{r saving_data}
if (!file.exists("./data/programmatic_output/Rep_Nest_CV_instance_newDrugs.RData")) {
  save(Rep_Nest_CV_instance_newDrugs, file = "./data/programmatic_output/Rep_Nest_CV_instance_newDrugs.RData")
}

if (!file.exists("./data/programmatic_output/Rep_Nest_CV_instance_allDosage.RData")) {
  save(Rep_Nest_CV_instance_newDrugs, file = "./data/programmatic_output/Rep_Nest_CV_instance_allDosage.RData")
}
```


## System and session info

```{r}
R.Version
sessionInfo()
```

