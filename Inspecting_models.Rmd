---
title: "Inspecting models 2.0"
author: "Florian Huber"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Setup, library loading

This part is the general setup, whichever model we are using.

```{r setup}
rm(list = ls())
# function to check if a package is installed, if so, load it, else install and then load it
source("./R/ipak.R")
# set chunk options and load libraries
source("./setup.R")
knitr::opts_chunk$set(cache = FALSE)
```

# Aim

To generate a report of performances, prediction probabilities for each drug, and feature 
importances. Use most important features to get a fingerprint for a MoA and generate 
heatmaps and PCA/tSNE/MDS maps.

# Report

## Which models are we talking about?

We will focus on random forests, top25pct, no chemical features, all dosages. 

```{r input_data}
matrix_container <- readRDS("./data/programmatic_output/matrix_container_ext.rds")
chosen_res <- filter_container(matrix_container, dosgs = "all", feats = "top25pct", 
  chemfeats = FALSE, models = "classif.randomForest")
stopifnot(nrow(chosen_res) == 1)
chosen_res
drugnfeats <- chosen_res$drug_feature_matrices[[1]]
res_obj <- get_resobj_from_row(chosen_res, dir = "./run_results_from_server/matrix_container_result/")

moas <- c("cell_wall", "dna", "protein_synthesis", "membrane_stress")
moa_colours <- c("cell_wall" = "#984ea3", "dna" = "#4daf4a", "membrane_stress" = "#377eb8", 
  "protein_synthesis" = "#e41a1c", "oxidative_stress" = "#636363", "protein_qc" = "#252525", 
  "pmf" = "#969696")
```

## What are the performances?

```{r}
plot_perf_from_container(chosen_res, what = "ROC")
plot_perf_from_container(chosen_res, what = "prec-recall")
```

## How are prediction probabilities distributed? 

### Dosage with highest probability

```{r, fig.height = 10}
walk(moas, plot_highest_probs, pred_data_obj = chosen_res$pred_data[[1]], 
  dosg_to_plot = "highest_prob")
```

### All dosages

```{r, fig.height = 20}
walk(moas, plot_highest_probs, pred_data_obj = chosen_res$pred_data[[1]], 
  dosg_to_plot = "all")
```

## Feature importances

```{r}
feat_imps <- get_feat_imps(res_obj)
head(feat_imps)

feat_imps_s <- summarise_feat_imps(feat_imps)
head(feat_imps_s)
```

Plot feature distributions across all nested CV repeats.

```{r}
fingerprint25 <- get_fingerprint(feat_imps_s, top_n = 25)

plot_importance_distribs(feat_imps = feat_imps, fingerprint = fingerprint25, 
  title = "Feature importances for random forests models, 
  25 most important features per MoA (no chem. feats, top25pct)")
```


We can see that the number of features that are considered differ between MoAs:

```{r}
ggplot(feat_imps_s, aes(x = moa)) + 
  geom_bar(aes(fill = factor(pct_models_bin))) + 
  scale_fill_discrete(name = "Present in how\nmany models?") + 
  labs(c = "Mode of action", y = "Number of genes")
```

Feature importances, broken down by the number of models they appear in:

```{r}
feat_imps_s %>%
  ggplot(aes(x = log2(median_importance))) + 
  geom_histogram(aes(fill = pct_models_bin)) + 
  facet_wrap( ~ moa)
```

Let's pull out all genes with a log2(median_importance) > -2.5 and then display 
it with tSNE. 

```{r}
fingerprint_log2 <- get_fingerprint(feat_imps_s, log2thresh = -2.5)
head(fingerprint_log2)
length(unique(fingerprint_log2$gene))

tsne_mat <- select(drugnfeats, drugname_typaslab, process_broad, 
  unique(fingerprint_log2$gene))
tsne_mat$process_broad <- factor(tsne_mat$process_broad)
set.seed(5)
tsne_res = Rtsne::Rtsne(X = tsne_mat[, -c(1,2)], dims = 3, perplexity = 10, 
  max_iter = 2000)

plotData <- data.frame(tsne_res$Y, MoA = tsne_mat$process_broad, 
  drug = paste0(tsne_mat$drugname_typaslab, "_", drugnfeats$conc))
colnames(plotData)[1:3] = c("tSNE1", "tSNE2", "tSNE3")

p1 <- plot_ly(plotData, x = ~tSNE1, y = ~tSNE2, z = ~tSNE3, color = ~MoA, 
  colors = moa_colours[levels(tsne_mat$process_broad)], 
  marker = list(size = 8, line = list(color = 'rgba(0, 0, 0, 1)', width = 1.5))) %>% 
  add_markers(text = ~drug) %>% 
  layout(title = "Best Features", scene = list(xaxis = list(title = 'tSNE1'), 
    yaxis = list(title = 'tSNE2'), zaxis = list(title = 'tSNE3')))
p1

save(p1, file = "./plots/tSNE_v2_morefeats.RData")
```

Try same thing with stricter threshold.

```{r}
fingerprint_log2_strict <- get_fingerprint(feat_imps_s, log2thresh = 0)
head(fingerprint_log2_strict)
length(unique(fingerprint_log2_strict$gene))

tsne_mat <- select(drugnfeats, drugname_typaslab, process_broad, 
  fingerprint_log2_strict$gene)
tsne_mat$process_broad <- factor(tsne_mat$process_broad)
set.seed(3)
tsne_res = Rtsne::Rtsne(X = tsne_mat[, -c(1,2)], dims = 3, perplexity = 10, 
  max_iter = 2000)

plotData <- data.frame(tsne_res$Y, MoA = tsne_mat$process_broad, 
  drug = paste0(tsne_mat$drugname_typaslab, "_", drugnfeats$conc))
colnames(plotData)[1:3] = c("tSNE1", "tSNE2", "tSNE3")

p2 <- plot_ly(plotData, x = ~tSNE1, y = ~tSNE2, z = ~tSNE3, color = ~MoA, 
  colors = moa_colours[levels(tsne_mat$process_broad)], 
  marker = list(size = 8, line = list(color = 'rgba(0, 0, 0, 1)', width = 1.5))) %>% 
  add_markers(text = ~drug) %>% 
  layout(title = "Best Features", scene = list(xaxis = list(title = 'tSNE1'), 
    yaxis = list(title = 'tSNE2'), zaxis = list(title = 'tSNE3')))
p2
save(p2, file = "./plots/tSNE_v2_fewerfeats.RData")
```


# Session information

```{r session_info}
R.version
sessionInfo()
```

