---
title: "Inspecting models"
author: "Florian Huber"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Setup, library loading

This part is the general setup, whichever model we are using.

```{r setup}
rm(list = ls())
# function to check if a package is installed, if so, load it, else install and then load it
source("./R/ipak.R")
# set chunk options and load libraries
source("./setup.R")
knitr::opts_chunk$set(cache = TRUE)

moa_cols <- c(cell_wall = "#1b9e77", dna = "#d95f02", 
  membrane_stress = "#7570b3", protein_synthesis = "#e7298a")
moas <- names(moa_cols)
```

# Aim

To generate a report of performances, prediction probabilities for each drug, 
and feature importances. Use most important features to get a fingerprint for a 
MoA and generate heatmaps and PCA/tSNE/MDS maps.

# One-vs-rest models

## Read in data

Make sure to run Model_lab.Rmd first.

```{r input_data}
matrix_container <- 
  readRDS("./data/programmatic_output/matrix_container_ext_2019.rds")
chosen_res <- readRDS("./data/programmatic_output/chosen_res.rds")
(load("./data/programmatic_output/the_line.RData"))
drugnfeats <- matrix_container$drug_feature_matrices[[the_line]]
mc_chosen <- matrix_container[the_line, ]

moa_cols <- c(cell_wall = "#1b9e77", dna = "#d95f02", 
  membrane_stress = "#7570b3", protein_synthesis = "#e7298a")
moas <- names(moa_cols)
```

## Performances

```{r}
plot_perf_from_container(mc_chosen, what = "ROC")
plot_perf_from_container(mc_chosen, what = "prec-recall")
```

## How are prediction probabilities distributed? 

### Dosage with highest probability

```{r, fig.height = 10}
walk(moas, plot_highest_probs, pred_data_obj = mc_chosen$pred_data[[1]], 
  dosg_to_plot = "highest_prob")
```

### All dosages

```{r, fig.height = 20}
walk(moas, plot_highest_probs, pred_data_obj = mc_chosen$pred_data[[1]], 
  dosg_to_plot = "all")
```

## Feature importances

```{r}
feat_imps <- get_feat_imps(chosen_res)
head(feat_imps)

feat_imps_s <- summarise_feat_imps(feat_imps)
feat_imps_s$med_imp_log2 <- log2(feat_imps_s$med_imp)
head(feat_imps_s)
```

Plot feature distributions across all nested CV repeats.

```{r, fig.height = 10}
my_top35 <- get_fingerprint(feat_imps_s, top_n = 35)

imp_list <- plot_importance_distribs(feat_imps = feat_imps, 
  fingerprint = my_top35)

with(imp_list, grid.arrange(cell_wall$plot, dna$plot, membrane_stress$plot, 
  protein_synthesis$plot, ncol = 2))
```

Very subjective way of defining a fingerprint:

```{r}
my_fingerprint <- c("MRCB", "YCFM", "SLT", "DDLB", "ASMA", 
  "RECC", "RECA", "HUPA", 
  "YRAP", "ISCR", "MALS", "SURA", "FADD", "LPCA_and_3_more", "RBFA", "PLDB", "IDND", 
  "DGKA", "ISPA", "RYFC", "MUTS", "SUCD", "YHDL", "KSGA", "PGPA", "FADD", "DKSA")
length(my_fingerprint)
```


We can see that the number of features that are considered differ between MoAs:

```{r}
ggplot(feat_imps_s, aes(x = moa)) + 
  geom_bar(aes(fill = factor(pct_models_bin))) + 
  scale_fill_discrete(name = "Present in how\nmany models?") + 
  labs(c = "Mode of action", y = "Number of genes")
```

Feature importances, broken down by the number of models they appear in:

Untransformed

```{r}
feat_imps_s %>%
  ggplot(aes(x = med_imp)) + 
  geom_histogram(aes(fill = pct_models_bin), alpha = 0.8) + 
  facet_wrap( ~ moa, scales = "free")
```

Log2

```{r}
feat_imps_s %>%
  ggplot(aes(x = med_imp_log2)) + 
  geom_histogram(aes(fill = pct_models_bin), alpha = 0.8) + 
  facet_wrap( ~ moa)
```


```{r}
feat_imps_s %>%
  ggplot(aes(x = med_imp_log2)) + 
  geom_histogram(aes(fill = pct_models_bin), alpha = 0.8)

IQR(log2(feat_imps_s$med_imp))
fivenum(log2(feat_imps_s$med_imp))
```


```{r}
# fingerprint_log2 <- get_fingerprint(feat_imps_s, log2thresh = -2)
# head(fingerprint_log2)
# length(unique(fingerprint_log2$gene))

tsne_mat <- select(drugnfeats, drugname_typaslab, process_broad, 
  my_fingerprint)
tsne_mat$process_broad <- factor(tsne_mat$process_broad)
set.seed(5)
tsne_res = Rtsne::Rtsne(X = tsne_mat[, -c(1,2)], dims = 3, perplexity = 10, 
  max_iter = 2000)

plotData <- data.frame(tsne_res$Y, MoA = tsne_mat$process_broad, 
  drug = paste0(tsne_mat$drugname_typaslab, "_", drugnfeats$conc))
colnames(plotData)[1:3] = c("tSNE1", "tSNE2", "tSNE3")

p1 <- plot_ly(plotData, x = ~tSNE1, y = ~tSNE2, z = ~tSNE3, color = ~MoA, 
  colors = moa_cols[levels(tsne_mat$process_broad)], 
  marker = list(size = 8, line = list(color = 'rgba(0, 0, 0, 1)', 
    width = 1.5))) %>% 
  add_markers(text = ~drug) %>% 
  layout(title = "Fingerprint tSNET map", scene = list(xaxis = list(title = 'tSNE1'), 
    yaxis = list(title = 'tSNE2'), zaxis = list(title = 'tSNE3')))
p1

save(p1, file = "./plots/tSNE_one-vs-rest_fingerprint.RData")
```

Try same thing with stricter threshold.

```{r, eval = FALSE, echo = FALSE}
fingerprint_log2_strict <- get_fingerprint(feat_imps_s, log2thresh = 0)
head(fingerprint_log2_strict)
length(unique(fingerprint_log2_strict$gene))

tsne_mat <- select(drugnfeats, drugname_typaslab, process_broad, 
  fingerprint_log2_strict$gene)
tsne_mat$process_broad <- factor(tsne_mat$process_broad)
set.seed(3)
tsne_res = Rtsne::Rtsne(X = tsne_mat[, -c(1,2)], dims = 3, perplexity = 10, 
  max_iter = 2000)

plotData <- data.frame(tsne_res$Y, MoA = tsne_mat$process_broad, 
  drug = paste0(tsne_mat$drugname_typaslab, "_", drugnfeats$conc))
colnames(plotData)[1:3] = c("tSNE1", "tSNE2", "tSNE3")

p2 <- plot_ly(plotData, x = ~tSNE1, y = ~tSNE2, z = ~tSNE3, color = ~MoA, 
  colors = moa_colours[levels(tsne_mat$process_broad)], 
  marker = list(size = 8, line = list(color = 'rgba(0, 0, 0, 1)', 
    width = 1.5))) %>% 
  add_markers(text = ~drug) %>% 
  layout(title = "Best Features", scene = list(xaxis = list(title = 'tSNE1'), 
    yaxis = list(title = 'tSNE2'), zaxis = list(title = 'tSNE3')))
p2
save(p2, file = "./plots/tSNE_v2_fewerfeats.RData")
```


# Multiclass model

```{r}
mcl <- readRDS("./data/programmatic_output/resampled_mcl_loo.rds")

mcl_imps <- get_feat_imps(mcl)
(mcl_imps_s <- group_by(mcl_imps, gene) %>%
  summarise(med_imp = median(importance)) %>%
  arrange(desc(med_imp)))

top50_mcl <- mcl_imps_s$gene[1:50]

filter(mcl_imps, gene %in% top50_mcl) %>%
  mutate(imp_log2 = log2(importance), 
    gene = fct_reorder(gene, imp_log2)) %>%
  ggplot(aes(x = gene, y = imp_log2)) + 
    stat_summary(geom = "pointrange", fun.y = "median", size = 0.5, 
      fun.ymin = function(x) {fivenum(x)[2]}, 
      fun.ymax = function(x) {fivenum(x)[4]}) + 
  coord_flip() + 
  labs(x = "Feature", y = "Feature importance (log2)")

# for example, new fingerprint:
my_fingerprint_mcl <- mcl_imps_s$gene[1:30]
(fp_imps <- log2(mcl_imps_s$med_imp)[match(my_fingerprint_mcl, mcl_imps_s$gene)])
names(fp_imps) <- my_fingerprint_mcl

save(my_fingerprint_mcl, file = "./data/programmatic_output/my_fingerprint_mcl.RData")
```

Overlap between fingerprints: 

```{r}
# venn(list(one_vs_rest = my_fingerprint, multiclass = my_fingerprint_mcl))
# 
# setdiff(my_fingerprint, my_fingerprint_mcl)
# setdiff(my_fingerprint_mcl, my_fingerprint)
```

tSNE with multiclass fingerprint:

```{r}
tsne_mat <- select(drugnfeats, drugname_typaslab, process_broad, 
  my_fingerprint_mcl)
tsne_mat$process_broad <- factor(tsne_mat$process_broad)
set.seed(5)
tsne_res = Rtsne::Rtsne(X = tsne_mat[, -c(1,2)], dims = 3, perplexity = 10, 
  max_iter = 2000)

plotData <- data.frame(tsne_res$Y, MoA = tsne_mat$process_broad, 
  drug = paste0(tsne_mat$drugname_typaslab, "_", drugnfeats$conc))
colnames(plotData)[1:3] = c("tSNE1", "tSNE2", "tSNE3")

p2 <- plot_ly(plotData, x = ~tSNE1, y = ~tSNE2, z = ~tSNE3, color = ~MoA, 
  colors = moa_cols[levels(tsne_mat$process_broad)], 
  marker = list(size = 8, line = list(color = 'rgba(0, 0, 0, 1)', 
    width = 1.5))) %>% 
  add_markers(text = ~drug) %>% 
  layout(title = "Fingerprint tSNET map", scene = list(xaxis = list(title = 'tSNE1'), 
    yaxis = list(title = 'tSNE2'), zaxis = list(title = 'tSNE3')))
p2

save(p2, file = "./plots/tSNE_multiclass_fingerprint.RData")
```

Heatmap with multiclass fingerprint:

```{r, eval = FALSE}
# take drug-feature matrix, add MIC information, rearrange rows by MoA broad 
# and specific
(mode_of_action <- read_csv("./data/programmatic_output/drug_moa_userfriendly.csv"))
(mic_info <- read_delim("./data/programmatic_output/MICs.csv", delim = ";"))
m <- drugnfeats
m <- left_join(m, mode_of_action[, c("drugname_typaslab", "process_subgroup")]) %>%
  left_join(mic_info[, c("drugname_typaslab", "mic_curated")])
m <- arrange(m, process_broad, process_subgroup, drugname_typaslab)
row_order <- m$drugname_typaslab

dfr <- as.data.frame(m[, c("process_broad")])
clusters <- readRDS("./data/programmatic_output/clusters.rds")

# matrix needed as input to Heatmaps
#m$n_dosg <- rep(rle(m$drugname_typaslab)$lengths, 
#  rle(m$drugname_typaslab)$lengths)
rownames(m) <- paste0(m$drugname_typaslab, "_", m$conc, " (", 
  m$mic_curated, ")")

m <- select(m, -drugname_typaslab, -conc, -process_broad, -process_subgroup, 
  -mic_curated) %>%
  select(my_fingerprint_mcl) %>% # cannot be mixed with previous select statement
  as.matrix()
dim(m)
colnames(m) <- paste0(colnames(m), " (", round(fp_imps[colnames(m)], 2), ")")
m[1:5, 1:5]

# Make annotation object
# ComplexHeatmap seems to have problems with tibbles! 
row_annot <- HeatmapAnnotation(df = dfr, 
  col = list(process_broad = moa_cols), which = "row", 
  name = "MoA", annotation_width = 3)
row_annot
draw(row_annot, 1:20)

my_distfun <- function(x, y) {1 - abs(cor(x, y))}
min_col <- plasma(2)[1]
max_col <- plasma(2)[2]

h <- Heatmap(matrix = m, 
  col = colorRamp2(breaks = c(-5, 5), colors = c(min_col, max_col)), 
  name = "S-score", 
  clustering_distance_rows = my_distfun, 
  clustering_distance_columns = my_distfun, 
  column_names_side = "top", 
  row_names_side = "right", 
  cluster_rows = FALSE, 
  # row_order = row_order, 
  #row_dend_side = "right", 
  row_names_gp = gpar(fontsize = 4), 
  column_names_gp = gpar(fontsize = 5), 
  cell_fun = function(j, i, x, y, width, height, fill) {
   grid.text(sprintf("%.2f", m[i, j]), x, y, 
     gp = gpar(col = "black", fontsize = 2))
   }) + row_annot

pdf("./plots/Fingerprint_mcl_heatmap.pdf", width = 7, height = 15)
h
dev.off()
```


# Session information

```{r session_info}
R.version
sessionInfo()
```

