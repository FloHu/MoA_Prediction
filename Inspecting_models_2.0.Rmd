---
title: "Inspecting models 2.0"
author: "Florian Huber"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Setup, library loading

This part is the general setup, whichever model we are using.

```{r setup}
rm(list = ls())
# function to check if a package is installed, if so, load it, else install and then load it
source("./R/ipak.R")
# set chunk options and load libraries
source("./setup.R")
knitr::opts_chunk$set(cache = TRUE)
```

# Aim

To generate a report of performances, prediction probabilities for each drug, and feature 
importances. Use most important features to generate heatmaps and PCA/tSNE/MDS maps. Builds up on 
work from Leonard in `Inspecting_models.Rmd`.


# Report

## Which models are we talking about?

We will focus on random forests, top25pct, no chemical features, all dosages. 

```{r input_data}
matrix_container <- readRDS("./data/programmatic_output/matrix_container_ext.rds")
chosen_res <- filter_container(matrix_container, dosgs = "all", feats = "top25pct", 
  chemfeats = FALSE, models = "classif.randomForest")
stopifnot(nrow(chosen_res) == 1)
chosen_res
drugnfeats <- chosen_res$drug_feature_matrices[[1]]
moas <- c("cell_wall", "dna", "protein_synthesis", "membrane_stress")
res_obj <- readRDS("./run_results_from_server/matrix_container_result/rf_hyp_param_all_top25pct_FALSE.rds")
moa_colours <- c("cell_wall" = "#984ea3", "dna" = "#4daf4a", "membrane_stress" = "#377eb8", 
  "protein_synthesis" = "#e41a1c", "oxidative_stress" = "#636363", "protein_qc" = "#252525", 
  "pmf" = "#969696")
```

## What are the performances?

```{r}
plot_perf_from_container(chosen_res, what = "ROC")
plot_perf_from_container(chosen_res, what = "prec-recall")
```

## How are prediction probabilities distributed? 

### Dosage with highest probability

```{r, fig.height = 10}
walk(moas, plot_highest_probs, pred_data_obj = chosen_res$pred_data[[1]], 
  dosg_to_plot = "highest_prob")
```

### All dosages

```{r, fig.height = 20}
walk(moas, plot_highest_probs, pred_data_obj = chosen_res$pred_data[[1]], 
  dosg_to_plot = "all")
```

## Feature importances

```{r}
# make a data frame with features + present in % of models
all_combs <- 
  list(cvrep = names(res_obj), fold = names(res_obj$`Nested CV 1`), moa = moas)
all_combs <- as_tibble(expand.grid(all_combs, stringsAsFactors = FALSE))

feat_imps <- pmap_dfr(all_combs, function(cvrep, fold, moa) {
  f <- getFeatureImportance(res_obj[[cvrep]][[fold]][[paste0("model_", moa)]])$res
  f <- tibble(gene = names(f), importance = unlist(f), cvrep = cvrep, fold = fold, moa = moa)
  return(f)
})

head(feat_imps)

# 10 repeats * 8 folds
max_nmodels <- 80
feat_imps_nest <- 
  group_by(feat_imps, moa, gene) %>%
  # remove rows where feature importance = 0
  filter(importance != 0) %>%
  nest(.key = "importances") %>%
  mutate(pct_models = map_dbl(importances, ~ length(.x[["importance"]]) / max_nmodels), 
    n_models = map_dbl(importances, ~ length(.x[["importance"]])), 
    median_importance = map_dbl(importances, ~ median(.x[["importance"]]))) %>%
  select(-one_of("importances")) %>%
  arrange(moa, desc(pct_models), desc(median_importance))
head(feat_imps_nest)

feat_imps_nest$pct_models_bin <- cut(feat_imps_nest$pct_models, 
  breaks = c(0, 0.75, 0.8, 0.85, 0.9, 0.95, 1), labels = c("0-75%", "75-80%", "80-85%", 
    "85-90%", "90-95%", "95-100%"))
```

We can see that the number of features that are considered differ between MoAs:

```{r}
ggplot(feat_imps_nest, aes(x = moa)) + 
  geom_bar(aes(fill = factor(pct_models_bin))) + 
  scale_fill_discrete(name = "Present in how\nmany models?") + 
  labs(c = "Mode of action", y = "Number of genes")
```

Feature importances, broken down by the number of models they appear in:

```{r}
feat_imps_nest %>%
  ggplot(aes(x = log2(median_importance))) + 
  geom_histogram(aes(fill = pct_models_bin)) + 
  facet_wrap( ~ moa)
```

Let's pull out all genes with a log2(median_importance) > -2.5

```{r}
tmp <- filter(feat_imps_nest, log2(median_importance) > -2.5) %>%
  arrange(gene)
head(tmp)
nrow(tmp)
# which corresponds to how many genes? - 
length(unique(tmp$gene))

# the genes that appear in more than one MoA are
more_than_once <- rle(tmp$gene)$values[rle(tmp$gene)$lengths > 1]
tmp[tmp$gene %in% more_than_once, ]

three_or_more <- rle(tmp$gene)$values[rle(tmp$gene)$lengths > 2]
tmp[tmp$gene %in% three_or_more, ]

fingerprint1 <- unique(tmp$gene)
```

Display result with heatmaps and tSNE maps.

```{r}
library(Rtsne)

tsne_mat <- select(drugnfeats, drugname_typaslab, process_broad, fingerprint1)
tsne_mat$process_broad <- factor(tsne_mat$process_broad)
tsne_res = Rtsne(X = tsne_mat[, -c(1,2)], dims = 3, perplexity = 10, max_iter = 2000)

plotData <- data.frame(tsne_res$Y, MoA = tsne_mat$process_broad, 
  drug = paste0(tsne_mat$drugname_typaslab, "_", drugnfeats$conc))
colnames(plotData)[1:3] = c("tSNE1", "tSNE2", "tSNE3")

set.seed(3)
p1 <- plot_ly(plotData, x = ~tSNE1, y = ~tSNE2, z = ~tSNE3, color = ~MoA, 
  colors = moa_colours[levels(tsne_mat$process_broad)], 
  marker = list(size = 8, line = list(color = 'rgba(0, 0, 0, 1)', width = 1.5))) %>% 
  add_markers(text = ~drug) %>% 
  layout(title = "Best Features", scene = list(xaxis = list(title = 'tSNE1'), 
    yaxis = list(title = 'tSNE2'), zaxis = list(title = 'tSNE3')))
p1

# View(arrange(drugnfeats[, 1:3], process_broad, drugname_typaslab, conc))
save(p1, file = "./plots/tSNE_v2_morefeats.RData")
```

Try same thing with stricter threshold.

```{r}
tmp <- filter(feat_imps_nest, log2(median_importance) > 0) %>%
  arrange(gene)
head(tmp)
nrow(tmp)
# which corresponds to how many genes? - 
length(unique(tmp$gene))

fingerprint2 <- unique(tmp$gene)

tsne_mat <- select(drugnfeats, drugname_typaslab, process_broad, fingerprint2)
tsne_mat$process_broad <- factor(tsne_mat$process_broad)
tsne_res = Rtsne(X = tsne_mat[, -c(1,2)], dims = 3, perplexity = 10, max_iter = 2000)

plotData <- data.frame(tsne_res$Y, MoA = tsne_mat$process_broad, 
  drug = paste0(tsne_mat$drugname_typaslab, "_", drugnfeats$conc))
colnames(plotData)[1:3] = c("tSNE1", "tSNE2", "tSNE3")

set.seed(3)
p2 <- plot_ly(plotData, x = ~tSNE1, y = ~tSNE2, z = ~tSNE3, color = ~MoA, 
  colors = moa_colours[levels(tsne_mat$process_broad)], 
  marker = list(size = 8, line = list(color = 'rgba(0, 0, 0, 1)', width = 1.5))) %>% 
  add_markers(text = ~drug) %>% 
  layout(title = "Best Features", scene = list(xaxis = list(title = 'tSNE1'), 
    yaxis = list(title = 'tSNE2'), zaxis = list(title = 'tSNE3')))
p2
save(p2, file = "./plots/tSNE_v2_fewerfeats.RData")
```

Save the fingerprints that we obtained.

```{r}
saveRDS(object = list(fingerprint1 = fingerprint1, fingerprint2 = fingerprint2, 
  feat_imps_nest = feat_imps_nest, feat_imps = feat_imps), 
  file = "./data/programmatic_output/fingerprints_1vsall.rds")
```



# Session information

```{r session_info}
R.version
sessionInfo()
```

