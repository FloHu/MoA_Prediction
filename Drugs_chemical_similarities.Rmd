---
title: "Drugs chemical similarities"
author: "Florian Huber, Leonard Dubois"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

# Setup

```{r setup}
# function to check if a package is installed, if so, load it, else install and then load it
source("./R/ipak.R")
# set chunk options and load libraries
source("./setup.R")

ipak(dendextend)

# custom functions
walk(list.files("./R", pattern = "*.R", full.names = T), source)

load(file = "data/the_matrix_allDrugs.RData")

drugs_full <- read.table("/Volumes/typas/Florian/dbsetup_tables/drugs.csv", header = T, 
                         sep = ";", stringsAsFactors = F, dec = ".")

```


# Aim of this notebook

During model construction, some bias can be introduced based on two (or more) very similar drugs. If 
during the sampling these drugs are separated between the test and training set, then one can argue 
that the model is tested with data it has already seen.

To prevent that, blocking can be introduced during the CV instances definition. Blocked individuals 
will always end up in the same set.

For that, chemical similarity beetween drugs must be computed. Here, fingerprints fom KNIME are used. 
These fingerprints use InChI (International Chemical Identifier)


# Analysis of chemical similarities

## Export InChI in a file

```{r}
all_inchi = 
   filter(drugs_full, drugname_typaslab %in% the_matrix_allDrugs$drugname_typaslab) %>% 
   select(drugname_typaslab, data_stdinchi)
write_tsv(all_inchi, col_names = T, path = "data/all_inchi.tsv")
```

Then one only has to use again the KNIME workflow used for dbsetup construction. Just the input and 
output files have to be changed.


## Read fingerprints

```{r}
drugs_RDkit_fingerprint = read_csv2(file = "data/RDkit_fingerprint.csv")
drugs_RDkit_fingerprint = merge(all_inchi, drugs_RDkit_fingerprint, by = "data_stdinchi")
colnames(drugs_RDkit_fingerprint) = c("data_stdinchi", "drugnames_typaslab", "RDkit_fingerprint")

drugs_morgan_fingerprint = read_csv2(file = "data/morgan_fingerprint.csv")
drugs_morgan_fingerprint = merge(all_inchi, drugs_morgan_fingerprint, by = "data_stdinchi")
colnames(drugs_morgan_fingerprint) = c("data_stdinchi", "drugnames_typaslab", "RDkit_fingerprint")

drugs_MACCS_fingerprint = read_csv2(file = "data/MACCS_fingerprint.csv")
drugs_MACCS_fingerprint = merge(all_inchi, drugs_MACCS_fingerprint, by = "data_stdinchi")
colnames(drugs_MACCS_fingerprint) = c("data_stdinchi", "drugnames_typaslab", "RDkit_fingerprint")
```


## Plot dendrogram of similarities

```{r}
plot_dend(drugs_fingerprint = drugs_RDkit_fingerprint, main = "Hclust of binary distance - RDKit fingerprint")

#### Leonard: doesn't work - why? 
# pdf("./plots/fingerprint_RDKit_hclust.pdf", width = 10, height = 10)
# plot_dend(drugs_fingerprint = drugs_RDkit_fingerprint, main = "Hclust of binary distance - RDKit fingerprint")
# dev.off()
```

```{r}
plot_dend(drugs_fingerprint = drugs_MACCS_fingerprint, main = "Hclust of binary distance - MACCS fingerprint")
```

```{r}
plot_dend(drugs_fingerprint = drugs_morgan_fingerprint, main = "Hclust of binary distance - Morgan fingerprint")
```


## Conclusions

RDKit fingerprint shows more similarities beetween drugs, in particular, drugs with the same mode of 
action which are way too close (more than 90% chemical fingerprint similarities) are :

- Group 1 : Phleomycin and Bleomycin
- Group 2 : Tetracycline, Minocycline, Streptonigrin
- Group 3 : Actinomycin D, Vancomycin and mitomycin C
- Group 4 : Ampicillin and Carbenicillin

Groups 1 and 2 can also be linked together for the maximum difference beetween two of the five drugs 
from these groups is less than 10%

MACCS fingerprint also shows similarity beetween Minocycline and Tetracycline



# Analysis of chemogenomic similarities. 

```{r}
#### Leonard: please rerun using correlation as a distance
#### then save the plot into ./plots like above

chemgen_mat = select(the_matrix_allDrugs, -process_broad, -drugname_typaslab)
# CecropinB is an outlier strongly influencing to final plot
rownames(chemgen_mat) = the_matrix_allDrugs$drugname_typaslab
chemgen_mat = chemgen_mat[-which(rownames(chemgen_mat) == "CECROPINB"), ]

dist_chemgen = dist(chemgen_mat, method = "euclidian")

color_moa = c(rainbow(4), rep("black", 3))
names(color_moa) = c("dna", "cell_wall", "membrane_stress", "protein_synthesis", "protein_qc", "oxidative_stress", "pmf")

hclust_chemgen = hclust(dist_chemgen, method = "complete")
dend_chemgen = as.dendrogram(hclust_chemgen, hang = 0.1)
    
labels_colors(dend_chemgen) <- color_moa[the_matrix_allDrugs[order.dendrogram(dend_chemgen), "process_broad"]]
par(mar = c(3,2,2,8)) 
dend_chemgen %>%
    set("labels_cex", 0.7) %>%
    set("branches_lwd", 1.5) %>%
    plot(horiz = T, cex = 0.5)

```

