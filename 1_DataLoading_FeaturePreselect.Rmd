---
title: "Predicting drug mode of action: loading data and preselecting features"
author: "Florian Huber, Leonard Dubois"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Setup, library loading

```{r}
# function to check if a package is installed, if so, load it, else install and then load it
source("./R/ipak.R")
# set chunk options and load libraries
source("./setup.R")

# ipak(dendextend)
# ipak(tree)
# ipak(randomForest)

# custom functions
walk(list.files("./R", pattern = "*.R", full.names = T), source)
```


# Loading and merging data

In all subsequent cases, the final goal is to have a matrix with the drugs in the rows and the 
features in the columns. We will refer to such a matrix as a `drug_feature_matrix`. In the next 
section we will generate different "versions" of this matrix, differing, for example, in the number 
of drugs or features selected or whether features were transformed in some way.


## Reading in and joining of tables, common preprocessing operations

```{r}
nichols_2011 <- read.table("/Volumes/typas/Florian/dbsetup_tables/nichols_2011.csv", header = T, 
                           sep = ";", stringsAsFactors = F)
strains <- read.table("/Volumes/typas/Florian/dbsetup_tables/strains.csv", header = T, 
                           sep = ";", stringsAsFactors = F)
strains_has_genes <- read.table("/Volumes/typas/Florian/dbsetup_tables/strains_has_genes.csv", 
                                header = T, sep = ";", stringsAsFactors = F)
genes <- read.table("/Volumes/typas/Florian/dbsetup_tables/genes.csv", header = T, sep = ";", 
                    stringsAsFactors = F)
# generated in project dbsetup using KNIME
drugs_full <- read.table("/Volumes/typas/Florian/dbsetup_tables/drugs.csv", header = T, 
                         sep = ";", stringsAsFactors = F, dec = ".")
drugs_full$X <- NULL
mode_of_action <- read.table("/Volumes/typas/Florian/dbsetup_tables/mode_of_action.csv", 
                             header = T, sep = ";", stringsAsFactors = F)
```

Add gene information to Nichols table, remove unnecessary columns.

```{r}
the_matrix <- 
   nichols_2011 %>%
   left_join(strains[, c("strain"), drop = F]) %>%
   left_join(strains_has_genes[, c("strain", "ugi")]) %>%
   left_join(genes[, c("ugi", "gene_synonym")]) %>%
   select(gene_synonym, drugname_typaslab, conc, sscore, qvalue, strain)

the_matrix$significant <- the_matrix$qvalue <= 0.05
```

Join drug tables with mode of action information.

```{r}
drugs_full <- left_join(drugs_full, mode_of_action[, c("moa_id", "process_broad")]) %>%
   select(-moa_id)

the_matrix <- filter(the_matrix, drugname_typaslab %in% drugs_full$drugname_typaslab)
```

If a gene doesn't interact with any drug, exclude it.

```{r}
the_matrix <- the_matrix %>%
   group_by(gene_synonym) %>% 
   filter(any(significant)) %>%
   ungroup()
```

This leaves us with `r length(unique(the_matrix$gene_synonym))` genes. Only a very small fraction 
of gene drug combinations are missing (less than 0.1%):

```{r}
t <- table(the_matrix$gene_synonym, the_matrix$drugname_typaslab)
sum(t == 0) / (nrow(t) * ncol(t))
```

For essential genes there were sometimes several hypomorphic mutants. We just want to keep one of 
them: always the one with most phenotypes over all conditions.

```{r}
the_matrix <- 
   group_by(the_matrix, gene_synonym) %>%
   do(select_mutant(.))

tmp <- group_by(the_matrix, gene_synonym) %>% 
   mutate(n = length(unique(strain))) %>%
   ungroup() %>%
   select(n)
stopifnot(all(tmp$n == 1))
rm(tmp)
```

Restructure the matrix to put drugs into rows, genes into columns. 

```{r}
# we need a matrix just indicating the significant s-scores for later on
the_matrix_signifs <- the_matrix

the_matrix <- select(the_matrix, gene_synonym, drugname_typaslab, conc, sscore)
the_matrix <- spread(the_matrix, key = gene_synonym, value = sscore)

the_matrix_signifs <- select(the_matrix_signifs, gene_synonym, drugname_typaslab, conc, significant)
the_matrix_signifs <- spread(the_matrix_signifs, key = gene_synonym, value = significant, fill = FALSE)
```

We replace all NA values with the median of all s-scores over all conditions for a particular 
mutant. `the_matrix` now contains all drug dosages and all mutants from nichols_2011 and forms the 
basis for all other derived matrices. 

```{r}
# check if all drug names are defined 
stopifnot(!any(is.na(the_matrix$drugname_typaslab)))
sel <- grep(colnames(the_matrix), pattern = "drugname_typaslab|conc")

the_matrix[, -sel] <- lapply(the_matrix[, -sel], function(x) {
   x[is.na(x)] <- median(x, na.rm = T)
   return(x)
})

if (any(sapply(the_matrix, is.na))) {
   stop("Undefined values present in the_matrix.")
}
```


# Generating different 'versions' of our matrix

## Drug selection and drug classification procedures

### Dosage selection

#### Approach 1: "`most_interactions`" 
Selects for each drug the one dosages with the highest number of significant interactions. If none 
or all are, keep the highest dosage. 

```{r}
the_matrix.bak <- the_matrix
the_matrix_signifs.bak <- the_matrix_signifs

selector <- 
   the_matrix_signifs %>%
   group_by(drugname_typaslab) %>%
   arrange(conc, .by_group = TRUE) %>%
   do(select_dosage_most_ias(.)) %>%
   ungroup() %>%
   pull(selector)

the_matrix <- the_matrix %>%
   group_by(drugname_typaslab) %>%
   arrange(conc, .by_group = TRUE) %>%
   ungroup()

the_matrix_mostias_nochemfeats <- the_matrix[selector, ]
```


## Feature selection and transformation procedures

### Selecting features with the highest variance

#### Top x per cent features

Sort features (i.e. mutants = genes here) by variance and select top x %. 

```{r}
# time to put all our data into a list
variances_to_select <- c(5, 10, 15, 20, 25, 30, 40, 50)

matrix_container <- 
   map(variances_to_select, 
       ~feature_selection_variance(percentTop = ., data = the_matrix_mostias_nochemfeats, featStart = 3))

names(matrix_container) <- paste0("the_matrix_mostias_nochemfeats_top", variances_to_select, "pct")
matrix_container <- prepend(matrix_container, 
                            list(the_matrix_mostias_nochemfeats_allmuts = the_matrix_mostias_nochemfeats))
```

### Adding chemical features

Don't use all chemical features from KNIME. Make tables with and without chemical features

```{r}
# check if all drugs in all tables are in our 'drugs_full' table
stopifnot(flatten_chr(map(matrix_container, "drugname_typaslab")) %in% drugs_full$drugname_typaslab)

drugs_full_selected_features <- drugs_full[, c("drugname_typaslab", "SlogP", "LabuteASA", "TPSA", 
                                               "ExactMW", "NumLipinskiHBA", "NumLipinskiHBD", 
                                               "NumRotatableBonds", "NumAmideBonds", 
                                               "NumRings", "NumAromaticRings", "NumSaturatedRings", 
                                               "NumAliphaticRings", "data_effective_rotor_count")]

tmp <- map(matrix_container, left_join, drugs_full_selected_features)
tmp <- setNames(tmp, gsub(x = names(matrix_container), pattern = "nochemfeats", replacement = "withchemfeats"))
matrix_container <- append(matrix_container, tmp)
rm(tmp)
```


## Adding drug classification (i.e. mode of action information) and metadata

```{r}
labels <- drugs_full[, c("drugname_typaslab", "process_broad")]

matrix_container <- lapply(matrix_container, function(x) {
   x$conc <- NULL
   x <- left_join(x, labels)
   x <- select(x, drugname_typaslab, process_broad, everything())
   return(x)
})

matrix_container <- annotate_list(matrix_container, add_metadata_dosage, "most_interactions")
matrix_container[1:9] <- annotate_list(matrix_container[1:9], add_metadata_included_datasets, "nichols_2011")
matrix_container[10:18] <- annotate_list(matrix_container[10:18], add_metadata_included_datasets, c("nichols_2011", "knime"))

# construct list with arguments for add_metadata_featureselection
my_args <- list(list(inds = c(1, 10), annot = "all"), 
                list(inds = c(2, 11), annot = "top5pct"), 
                list(inds = c(3, 12), annot = "top10pct"), 
                list(inds = c(4, 13), annot = "top15pct"), 
                list(inds = c(5, 14), annot = "top20pct"), 
                list(inds = c(6, 15), annot = "top25pct"), 
                list(inds = c(7, 16), annot = "top30pct"), 
                list(inds = c(8, 17), annot = "top40pct"), 
                list(inds = c(9, 18), annot = "top50pct"))

# now subset and annotate matrix_container using each of the above list elements
matrix_container <- flatten(sapply(seq_along(my_args), function(argpos) {
   where <- my_args[[argpos]][["inds"]]
   what <- my_args[[argpos]][["annot"]]
   return(annotate_list(matrix_container[where], add_metadata_featureselection, what))
}, USE.NAMES = TRUE, simplify = FALSE))
```


# System and session info

```{r}
R.version
sessionInfo()
```
