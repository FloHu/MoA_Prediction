---
title: "Predicting drug mode of action: loading data and preselecting features"
author: "Florian Huber, LÃ©onard Dubois"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Setup, library loading

```{r}
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(message = T)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(error = T)
knitr::opts_chunk$set(cache = T)
Sys.setlocale("LC_ALL", "en_IE.UTF-8")

library(tidyverse)
library(mlr)
library(dendextend)
library(tree)
library(randomForest)

walk(list.files("./R", pattern = "*.R", full.names = T), source)
```


# Loading and merging data

## Read in tables, join them

```{r}
nichols_2011 <- read.table("/Volumes/typas/Florian/dbsetup_tables/nichols_2011.csv", header = T, 
                           sep = ";", stringsAsFactors = F)
strains <- read.table("/Volumes/typas/Florian/dbsetup_tables/strains.csv", header = T, 
                           sep = ";", stringsAsFactors = F)
strains_has_genes <- read.table("/Volumes/typas/Florian/dbsetup_tables/strains_has_genes.csv", 
                                header = T, sep = ";", stringsAsFactors = F)
genes <- read.table("/Volumes/typas/Florian/dbsetup_tables/genes.csv", header = T, sep = ";", 
                    stringsAsFactors = F)
# KNIME table
drugs_full <- read.table("/Volumes/typas/Florian/dbsetup_tables/drugs_full.csv", header = T, 
                         sep = ";", stringsAsFactors = F, dec = ",")
drugs_full$X <- NULL
mode_of_action <- read.table("/Volumes/typas/Florian/dbsetup_tables/mode_of_action.csv", 
                             header = T, sep = ";", stringsAsFactors = F)
```

Add gene information to Nichols table, remove unnecessary columns.

```{r}
the_matrix <- 
   nichols_2011 %>%
   left_join(strains[, c("strain"), drop = F]) %>%
   left_join(strains_has_genes[, c("strain", "ugi")]) %>%
   left_join(genes[, c("ugi", "gene_synonym")]) %>%
   select(gene_synonym, drugname_typaslab, conc, sscore, qvalue, strain)

the_matrix$significant <- the_matrix$qvalue <= 0.05
```

Join drug tables with mode of action information. We only keep drugs which target 'cell_wall', 
'dna', 'protein_synthesis' and 'membrane_stress' because the other MoAs don't have enough class 
members for predictions. Exclude the respective drugs from `the_matrix`. 

```{r}
moas_to_keep <- c("cell_wall", "dna", "protein_synthesis", "membrane_stress")

drugs_full <- left_join(drugs_full, mode_of_action[, c("moa_id", "process_broad")]) %>%
   select(-moa_id) %>% 
   filter(process_broad %in% moas_to_keep)

the_matrix <- filter(the_matrix, drugname_typaslab %in% drugs_full$drugname_typaslab)
```

For essential genes there were sometimes several hypomorphic mutants. We just want to keep one of 
them: the one with most phenotypes over all conditions.

```{r}
the_matrix <- 
   group_by(the_matrix, gene_synonym) %>%
   do(select_mutant(.))

tmp <- group_by(the_matrix, gene_synonym) %>% 
   mutate(n = length(unique(strain)))
stopifnot(all(tmp$n == 1))
```


Select drug dosages: if one of the dosages is significant, keep that one, if none or all are, keep 
the highest dosage. 

```{r}
the_matrix <- the_matrix %>%
   group_by(gene_synonym, drugname_typaslab) %>%
   do(select_dosage(.)) %>%
   ungroup()
```

If a gene doesn't interact with any drug, exclude it.

```{r}
the_matrix <- the_matrix %>%
   group_by(gene_synonym) %>% 
   mutate(significant_any = any(significant)) %>%
   ungroup()

the_matrix <- the_matrix[the_matrix$significant_any, ]
```

This leaves us with `r length(unique(the_matrix$gene_synonym))` genes. Only a very small fraction 
of gene drug combinations are missing (less than 0.1%):

```{r}
t <- table(the_matrix$gene_synonym, the_matrix$drugname_typaslab)
stopifnot(all(t < 2))
sum(t == 0) / sum(t < 2)
```

Now we can start constructing the final matrix. 

```{r}
the_matrix <- select(the_matrix, gene_synonym, drugname_typaslab, sscore)
the_matrix <- spread(the_matrix, key = gene_synonym, value = sscore)
```

We replace all NA values with the median of all s-scores over all conditions for a particular 
mutant. 

```{r}
# check if all drug names are defined 
stopifnot(!any(is.na(the_matrix$drugname_typaslab)))
sel <- grep(colnames(the_matrix), pattern = "drugname_typaslab")

the_matrix[, -sel] <- lapply(the_matrix[, -sel], function(x) {
   x[is.na(x)] <- median(x, na.rm = T)
   return(x)
})

if (any(sapply(the_matrix, is.na))) {
   stop("Undefined values present in the_matrix.")
}
```

Merge `the_matrix` with drug features. Make table `labels` containing the correct MoA 
classifications. 

```{r}
stopifnot(all(the_matrix$drugname_typaslab %in% drugs_full$drugname_typaslab))

drugs_full_selected_features <- drugs_full[, c("drugname_typaslab", "SlogP", "LabuteASA", "TPSA", 
                                               "ExactMW", "NumLipinskiHBA", "NumLipinskiHBD", 
                                               "NumRotatableBonds", "NumAmideBonds", "NumHeteroAtoms", 
                                               "NumHeavyAtoms", "NumAtoms", "NumStereocenters", 
                                               "NumUnspecifiedStereocenters", "NumRings", 
                                               "NumAromaticRings", "NumSaturatedRings", 
                                               "NumAliphaticRings", "data_effective_rotor_count")]

the_matrix <- left_join(the_matrix, drugs_full_selected_features)

labels <- drugs_full[, c("drugname_typaslab", "process_broad")]
```

Done. 

```{r}
save("the_matrix", "labels", file = "the_matrix.RData")
```


## Do further feature preselection

```{r}
the_matrix <- merge(x = labels, y = the_matrix, by = "drugname_typaslab", all.y = T)
```


### Taking features with the highest variance

#### Top x per cent

Top 10 % of features sorted by variance. 

```{r}
the_matrix_top10pct <- feature_selection_variance(the_matrix, featStart = 3, percentTop = 10)
the_matrix_top5pct <- feature_selection_variance(the_matrix, featStart = 3, percentTop = 5)

# exclude some of the chemical features that will have high variance but don't seem really 
# important
#### FIX later
# crude way of defining which columns represent chemical features:
chem_features <- colnames(the_matrix_top10pct)[nchar(colnames(the_matrix_top10pct)) > 4]
chem_features <- setdiff(chem_features, c("drugname_typaslab", "process_broad"))
chem_features_to_exclude <- c("NumAtoms", "NumHeavyAtoms", "NumHeteroAtoms", "NumStereocenters", 
                              "NumUnspecifiedStereocenters")
chem_features_kept <- setdiff(chem_features, chem_features_to_exclude)

the_matrix_top10pct <- the_matrix_top10pct[, ! (colnames(the_matrix_top10pct) %in% 
                                                   chem_features_to_exclude)]

the_matrix_top5pct <- the_matrix_top5pct[, ! (colnames(the_matrix_top5pct) %in% 
                                                 chem_features_to_exclude)]

save("the_matrix_top10pct", file = "the_matrix_top10pct.RData")
save("the_matrix_top5pct", file = "the_matrix_top5pct.RData")
```


#### Do hierarchical clustering on the genes

This was part of the first few prediction attempts last year. Idea: do hierarchical clustering of 
all genes based on the correlations of their s-scores, then make 50/200 clusters and select the 
medoids. Try both complete and average linkage. 

```{r}
# first need a matrix of all the genes
genes_only <- select(the_matrix, -drugname_typaslab, -process_broad, -(SlogP:data_effective_rotor_count))
high_to_lowvar <- sort(apply(genes_only, 2, var), decreasing = T)

feature_container <- list()

# these are the 200 most variable genes (i.e. sorted by variance)
feature_container$mostvar_200 <- names(high_to_lowvar[1:200])
feature_container$mostvar_50 <- names(high_to_lowvar[1:50])

gene_mat <- as.matrix(genes_only)
corm <- (1 - abs(cor(gene_mat, use = "complete.obs")))
dists <- as.dist(corm)
cluster_methods <- c('complete', 'average') # single and ward gave some C stack error
n_clusters <- c(50, 200)

# plot dendrograms and pull out genes: keep only one gene (the medoid of each cluster)
# btw: calculation of centroids if only distances given?
for (m in cluster_methods) {
   hc <- hclust(dists, method = m)
   hc_p <- as.dendrogram(hc)
   for (k in n_clusters){
      clusts <- cutree(hc, k = k)
      feature_container[[paste0("hclust_", m, "_", k, "_medoids")]] <- retrieve_medoids(clusts, corm)
      pdf(file = paste0("./plots/Dendrogram_", k, "_clusters", m, ".pdf"), width = 200, height = 1000)
      hc_p %>%
         set("branches_k_color", value = c(2, 3, 4), k = k) %>%
         highlight_branches_lwd() %>%
         hang.dendrogram() %>%
         rotate(rev(colnames(gene_mat))) %>%
         plot(horiz = T)
      abline(v = c(0.8, 0.9, 0.95, 1), col = 2, lty = 2)
      dev.off()
   }
}

save("feature_container", file = "feature_container.RData")
```

Save matrix including only the 200 genes based on hierarchical clustering with complete linkage as 
well as the chemical features from above.

```{r}
the_matrix_hclust <- 
   the_matrix[, c("drugname_typaslab", "process_broad", 
                  c(feature_container$hclust_complete_200_medoids), 
                  c(chem_features_kept))]
save("the_matrix_hclust", file = "the_matrix_hclust.RData")
```


#### Excluding correlated features

<!--
TO DO
Exclude drug features that correlate with another drug feature with 0.9. 
-->

```{r eval = F, echo = F}
# and the drug features we also want to keep 
selected_drug_features <- colnames(select(the_matrix, SlogP:data_effective_rotor_count))
round(cor(the_matrix[, selected_drug_features]), digits = 3)


# plotting all variables will make a huge plot 
# generate a sequence of pairplots with a maximum of 9 variables per plot
# breakpoints:
my_stepsize = 9
my_steps <- c(seq(from = 1, to = length(selected_drug_features), by = my_stepsize), 
              length(selected_drug_features))

# generate integer sequences from one breakpoint to the next
for (ind in seq_along(my_steps)) {
   if (ind == length(my_steps)) {
      break # we've reached the end, no further plots needed
   }
   my_seq <- seq(from = my_steps[ind], to = (my_steps[ind + 1] - 1))
   pdf(paste0("./plots/drugfeatures_pairplot_", ind, ".pdf"), width = my_stepsize * 2, 
       height = my_stepsize * 2)
   pairs(x = the_matrix[, selected_drug_features[my_seq]], 
         labels = colnames(the_matrix[, selected_drug_features[my_seq]]))
   dev.off()
}

```



# System and session info

```{r}
R.version
sessionInfo()
```

