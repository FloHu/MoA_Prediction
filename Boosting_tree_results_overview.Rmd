---
title: "Boosting Tree model : Results overview"
author: "Florian Huber, Leonard Dubois"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

# Setup

```{r setup}
# function to check if a package is installed, if so, load it, else install and then load it
source("./R/ipak.R")
# set chunk options and load libraries
source("./setup.R")

ipak(randomForest)
ipak(xgboost)
ipak(grid)
ipak(gridExtra)

# custom functions
walk(list.files("./R", pattern = "*.R", full.names = T), source)
```


# Analysis

The grid used to tune the models was the following one :
- `nrounds` (number of trees) : 200, 500
- `max_depth` : 1, 2, 3
- `eta` (learning rate) : 0.01, 0.1, 0.5


## Loading results

```{r}
walk(list.files("./run_results_from_server", pattern = "result_XGBT*", full.names = T ), function(x) load(x , envir = .GlobalEnv))
load("./run_results_from_server/result_greedy_XGBT_allFeat_allDrugs_tuneMMCE.RData")

load("./run_results_from_server/result_greedy_RF_10pc_allDrugs_tuneMMCE.RData") # uses 10 pc variance features, mtry = grid search
load("./run_results_from_server/result_RF_27feat_allDrugs_tuneMMCE.RData") # uses all features, but mtry = 27 - best performer for random forests
load("./run_results_from_server/result_RF_10pc_allDrugs_tuneMMCE.RData")
# best for gradient boosting: result_XGBT_10pc_allDrugs
#walk(list.files("./run_results_from_server", pattern = "result_RF_*", full.names = T ), function(x) load(x , envir = .GlobalEnv))
```


## Some plots and conclusions

### Plots for presentation

Compare best RF vs. best XGBT outcomes - performances are similar. In both cases it's: all drugs, 
optimising MMCE, using top 10 per cent variance features.

```{r}
(p <- compare_ROC_2models(result_XGBT_10pc_allDrugs_tuneMMCE, 
                          result_RF_10pc_allDrugs_tuneMMCE, 
                          moa = "all"))
ggsave(filename = "./plots/present_bestXGBT_vs_bestRF.pdf", 
       p, width = 14, height = 7)
```


Compare features: 
Wilcoxon test based feature selection shows that some features contain information, others don't.

```{r}
(p <- compare_ROC_2models(result_XGBT_10topWilcox_allDrugs_tuneMMCE, 
                          result_XGBT_10worstWilcox_allDrugs_tuneMMCE, 
                          moa = "all"))
ggsave(filename = "./plots/present_10topWilcoxXGBT_vs_10worstWilcoxXGBT.pdf", 
       p, width = 14, height = 7)
```


Compare features: using all vs. top 10 pc variance. Both RF and XGBT improve when using top 10% 
variance features instead of all. 

```{r}
load("run_results_from_server/result_greedy_RF_allFeat_allDrugs_tuneMMCE.RData")
load("run_results_from_server/result_RF_10pc_allDrugs_tuneMMCE.RData")

(p <- compare_ROC_2models(result_greedy_RF_allFeat_allDrugs_tuneMMCE, 
                    result_RF_10pc_allDrugs_tuneMMCE, moa = "all"))
ggsave(filename = "./plots/present_allFeatsRF_vs_10pcRF.pdf", 
       p, width = 14, height = 7)

rm(result_greedy_RF_allFeat_allDrugs_tuneMMCE)

load("run_results_from_server/result_greedy_XGBT_allFeat_allDrugs_tuneMMCE.RData")
load("run_results_from_server/result_XGBT_10pc_allDrugs_tuneMMCE.RData")

(p <- compare_ROC_2models(result_greedy_XGBT_allFeat_allDrugs_tuneMMCE, 
                    result_XGBT_10pc_allDrugs_tuneMMCE, moa = "all"))
ggsave(filename = "./plots/present_allFeatsXGBT_vs_10pcXGBT.pdf", 
       p, width = 14, height = 7)
```


Compare features: top 5 vs. top 10 pc variance. Both RF and XGBT seem to be slightly better at top 
10 per cent than at top 5 per cent variance. 

```{r}
(p <- compare_ROC_2models(result_XGBT_10pc_allDrugs_tuneMMCE, 
                          result_XGBT_5pc_allDrugs_tuneMMCE, 
                          moa = "all"))
ggsave(filename = "./plots/present_10pcXGBT_vs_5pcXGBT.pdf", 
       p, width = 14, height = 7)

load("run_results_from_server/result_RF_10pc_allDrugs_tuneMMCE.RData")
load("run_results_from_server/result_RF_5pc_allDrugs_tuneMMCE.RData")
(p <- compare_ROC_2models(result_RF_10pc_allDrugs_tuneMMCE, 
                          result_RF_5pc_allDrugs_tuneMMCE, 
                          moa = "all"))
ggsave(filename = "./plots/present_10pcRF_vs_5pcRF.pdf", 
       p, width = 14, height = 7)
```


Comparing ppv vs. mmce optimisation

```{r}
(p <- compare_ROC_2models(result_XGBT_10pc_allDrugs_tuneMMCE, 
                          result_XGBT_10pc_allDrugs_tunePPV, 
                          moa = "all"))
ggsave(filename = "./plots/present_ppvXGBT_vs_mmceXGBT.pdf", 
       p, width = 14, height = 7)

```


Get a precision-recall curve, then discuss issue with curves: imbalanced class problem. 

```{r}
p <- grid.arrange(nrow = 1, ncol = 2, 
                  plot_ROC_allRep(result_XGBT_10pc_allDrugs_tuneMMCE, moa = "all"), 
                  plot_prec_recall(result_XGBT_10pc_allDrugs_tuneMMCE, moa = "all"))

ggsave(filename = "./plots/present_prec-rec-auc_XGBT.pdf", 
       p, width = 14, height = 7)
```


Precision-recall curves and class imbalances.

```{r}
my_res <- plot_ROC_optThres(result_XGBT_10pc_allDrugs_tuneMMCE, moa = "dna")
View(my_res$confMat)

ggsave(filename = "./plots/present_optThres.pdf", width = 14, height = 7, 
       plot = my_res$plot)
```


### Other points 

```{r fig.height=5, fig.width=12}
# Effect of mesure used for HyperParameter tuning
compare_ROC_2models(res1 = result_XGBT_5pc_allDrugs_tuneMMCE, res2 = result_XGBT_5pc_allDrugs_tunePPV, moa = "all")
compare_ROC_2models(res1 = result_XGBT_5pc_tuneMMCE, res2 = result_XGBT_5pc_tunePPV, moa = "all")
```

The measure PPV or MMCE chosen for hyperparamter tuning seems to have no effect when all Drugs used 
(MMCE slightly better). In models built with only the 72 drugs whose MoA is predicted, slight 
changes are present but could also be explained by a lack a robustness 

```{r fig.height=5, fig.width=12}
# Effect of measure used for HyperParameter tuning
compare_ROC_2models(res1 = result_XGBT_10pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tunePPV, moa = "all")
compare_ROC_2models(res1 = result_XGBT_10pc_tuneMMCE, res2 = result_XGBT_10pc_tunePPV, moa = "all")

```

Slight differences here, nothing to conclude from ROC curves


#### Using all drugs for prediction or only those falling into one of our 4 classes

Here with 10% variance. Using all drugs seems to slightly improve performances. 

```{r fig.height=5, fig.width=12}
compare_ROC_2models(res1 = result_XGBT_10pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_tuneMMCE, moa = "all")
compare_ROC_2models(res1 = result_XGBT_10pc_allDrugs_tunePPV, res2 = result_XGBT_10pc_tunePPV, moa = "all")

```

In brief, no strong differences but using all drugs should be more robust, so focus on this kind of 
dataset. Moreover, one measure for tuning has to be chosen. MMCE seems better than PPV, which cannot 
always be computed in small inner folds. 


Chosing 5 % seems to make well predicted MoA slightly better and badly predicted MoA slightly worse: 

```{r fig.height=5, fig.width=12}
# Effect of mesure used for HyperParameter tuning
compare_ROC_2models(res1 = result_XGBT_5pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "all")
```

```{r fig.height=5, fig.width=7}
compare_ROC_2models(res1 = result_XGBT_5pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "dna")
compare_ROC_2models(res1 = result_XGBT_5pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "cell_wall")
compare_ROC_2models(res1 = result_XGBT_5pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "membrane_stress")
compare_ROC_2models(res1 = result_XGBT_5pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "protein_synthesis")
```


#### Comparison of best runs RF vs. XGB

grid for RF was 
- `ntree` (number of trees) : 200, 500
- `mtry` : p, p*(3/4), p/2, p/4, sqrt(p)


```{r}
load("./run_results_from_server/result_RF_10pc_allDrugs_tuneMMCE.RData")
load("./run_results_from_server/result_XGBT_10pc_allDrugs_tuneMMCE.RData")
```


```{r fig.height=5, fig.width=7}
compare_ROC_2models(res1 = result_RF_10pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "dna")
compare_ROC_2models(res1 = result_RF_10pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "cell_wall")
compare_ROC_2models(res1 = result_RF_10pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "membrane_stress")
compare_ROC_2models(res1 = result_RF_10pc_allDrugs_tuneMMCE, res2 = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "protein_synthesis")

```


## RF 10 % top variance all drugs, tune MMCE

```{r fig.height=5, fig.width=7}
plot_mean_perf(res = result_RF_10pc_allDrugs_tuneMMCE, moa = "all", meas = mmce)
plot_mean_perf(res = result_RF_10pc_allDrugs_tuneMMCE, moa = "all", meas = auc)
```


## XGBT 10 % top variance all drugs, tune MMCE

```{r fig.height=5, fig.width=7}
plot_mean_perf(res = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "all", meas = mmce)
plot_mean_perf(res = result_XGBT_10pc_allDrugs_tuneMMCE, moa = "all", meas = auc)
```



## A closer look at Random Forest objects

Thanks to very convenients functions lots of interesting plot are available

```{r}

plot_RF_perf_allRep = function(res = result_RF_10pc_allDrugs_tuneMMCE, moa = "dna"){
    res_all500 = matrix(0, nrow = 500, ncol = 3)
    res_all200 = matrix(0, nrow = 200, ncol = 3)
    nb500 = 0
    nb200 = 0
    
    plot(NULL, xlim = c(1,500), ylim = c(0,1), xlab = "Number of trees", ylab = "Error rate")
    for (i in 1:length(res)){
        for(j in 1:length(res[[1]])){
            rf_res = res[[i]][[j]][[paste0("model_",moa)]]$learner.model
            plot(rf_res, lty = 1, col = c("lightgrey", "lightblue", "orange"), add =T)
            if(dim(rf_res$err.rate)[1] == 500){
                res_all500 = res_all500 + rf_res$err.rate
                nb500 = nb500 +1
            }else{
                res_all200 = res_all200 + rf_res$err.rate
                nb200 = nb200 + 1
            }
        }
    }
    
    res200 = (res_all200 +res_all500[1:200,]) / (nb200 + nb500)
    res500 = res_all500 / nb500
    
    lines(res200[ ,1], lty = 1, lwd = 3, col = "black")
    lines(x = seq(201, 500), y = res500[201:500, 1], lty = 1, lwd = 3, col = "black")
    lines(res200[ ,2], lty = 1, lwd = 3, col = "blue")
    lines(x = seq(201, 500), y = res500[201:500, 2], lty = 1, lwd = 3, col = "blue")
    lines(res200[ ,3], lty = 1, lwd = 3, col = "red")
    lines(x = seq(201, 500), y = res500[201:500, 3], lty = 1, lwd = 3, col = "red")
    legend("topright", legend= colnames(res500), col=c("black", "blue", "red"), lwd=3, cex=1)  
}


plot_RF_perf_allRep(res = result_RF_10pc_allDrugs_tuneMMCE, moa = "dna")
plot_RF_perf_allRep(res = result_RF_10pc_allDrugs_tuneMMCE, moa = "cell_wall")
plot_RF_perf_allRep(res = result_RF_10pc_allDrugs_tuneMMCE, moa = "membrane_stress")
plot_RF_perf_allRep(res = result_RF_10pc_allDrugs_tuneMMCE, moa = "protein_synthesis")

```




```{r}
rf_res = result_RF_10pc_allDrugs_tuneMMCE[[1]][[1]]$model_dna
rf_res$features 

getTree(rf_res$learner.model, k = 1)
```
