---
title: ""
author: "Florian Huber"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Setup

```{r setup}
source("./setup.R")
```


## Derive chemogenomic fingerprint

Get feature importances from retrained model. 

```{r}
mod <- readRDS(file = "./data/programmatic_output/trained_model.rds")

# getFeatureImportance(mod)$res is a 1-row data frame with each column being 
# a gene
mod_imp <- gather(getFeatureImportance(mod)$res, key = "gene", value = "imp", 
  everything()) %>%
  filter(imp != 0) %>%
  arrange(desc(imp)) %>% 
  mutate(gene = fct_reorder(gene, imp), log2imp = log2(imp)) %>%
  as_tibble()

mod_imp
```

Showing it on a linear scale doesn't help much. The following plot suggests 
some "jumps" in the feature importance but this could be just by chance. One 
could take these "blocks" as cutoff for the fingerprint:

  * block 1: 4 genes
  * block 2: 5 genes
  * block 3: 12 genes
  * block 4: 13 genes
  * block 5: 14 genes

General distribution. 

```{r}
ggplot(mod_imp, aes(x = log2imp)) + 
  geom_histogram(bins = 45) + 
  comparison_theme + 
  labs(x = "Feature importance (log2)", y = "Count") + 
  theme(panel.grid = element_blank())

ggsave(filename = "./plots/Feature_importance_hist.pdf", width = 45, 
  height = 45, units = "mm")
```


```{r, fig.height = 8}
ggplot(mod_imp[1:75, ], aes(x = log2imp, y = gene)) + 
  geom_point()
```


```{r, include = FALSE}
# for paper
ggplot(mod_imp[1:50, ], aes(x = log2imp, y = gene)) + 
  geom_point(size = 0.75) + 
  comparison_theme + 
  theme(panel.grid = element_blank()) + 
  labs(x = "Feature importance (log2)", y = "Gene")

ggsave(filename = "./plots/Feature_importance_top50.pdf", width = 87, 
  height = 110, units = "mm")
```

Take, say, the first 4 blocks for the fingerprint = 34 genes: 

```{r}
ggplot(mod_imp[1:34, ], aes(x = log2(imp), y = gene)) + 
  geom_point()

fingerprint_mcl <- as.character(mod_imp$gene[1:34])
fingerprint_mcl_imps <- mod_imp$log2imp[1:34]
names(fingerprint_mcl_imps) <- fingerprint_mcl

saveRDS(fingerprint_mcl, file = "./data/programmatic_output/fingerprint_mcl.rds")
write.table(x = fingerprint_mcl, row.names = FALSE, col.names = FALSE, 
  quote = FALSE, file = "./data/programmatic_output/fingerprint_mcl.csv")
```


```{r, include = FALSE, eval = FALSE}
## FOR POSTER ------------
my_cutoff <- mod_imp$log2imp[mod_imp$gene == "NADA"]

mutate(mod_imp, above_thresh = log2imp >= my_cutoff) %>% 
  ggplot(aes(x = log2imp, fill = above_thresh)) + 
    geom_histogram(bins = 35) + 
    comparison_theme + 
    labs(x = "Log2 feature importance", y = "Count") + 
    scale_fill_manual(values = c("#404040", "#ca0020")) + 
    poster_theme + 
    theme(legend.position = "None")

ggsave(filename = "./plots/POSTER_histogram.pdf", width = 120, height = 110, 
  units = "mm")

## FOR PAPER ------
mutate(mod_imp, above_thresh = log2imp >= my_cutoff) %>% 
  ggplot(aes(x = log2imp, fill = above_thresh)) + 
    geom_histogram(bins = 35) + 
    comparison_theme + 
    labs(x = "Log2 feature importance", y = "Count") + 
    scale_fill_manual(values = c("#404040", "#ca0020")) + 
    paper_theme + 
    theme(legend.position = "None")

ggsave(filename = "./plots/paper/FeatImp_histogram.pdf", width = 50, height = 50, 
  units = "mm")
```



# tSNE, hclust, PCA

Aim is to compare PCA, hierarchical clustering, tSNE of complete feature set 
and the fingerprint feature set on both the training data and the training data 
+ the unknown data. 

## Datasets

```{r}
m_all <- readRDS("./data/programmatic_output/m_all.rds")
m_all_alldrugs <- readRDS("./data/programmatic_output/m_all_alldrugs.rds")
```


## tSNE maps

All features, training set. 

```{r}
plot_tsne(m_all, save = TRUE, file = "./data/programmatic_output/tSNE_allfeats_training.rds")
```

With chemogenomic fingerprint, training set. 

```{r}
select(m_all, drugname_typaslab, conc, process_broad, fingerprint_mcl) %>%
  plot_tsne(save = TRUE, file = "./data/programmatic_output/tSNE_fingerprint_training.rds")
```


```{r, include = FALSE, eval = FALSE}
## FOR POSTER --------------
tsne_mat <- m_all
fingerprint_mcl <- readRDS("./data/programmatic_output/fingerprint_mcl.rds")
tsne_mat <- m_all[, c("drugname_typaslab", "conc", "process_broad", fingerprint_mcl)]

tsne_mat$process_broad <- factor(tsne_mat$process_broad)
set.seed(5)

stopifnot(all(colnames(tsne_mat)[1:3] %in% c("drugname_typaslab", "conc", "process_broad")))

tsne_res <- Rtsne::Rtsne(X = tsne_mat[, -c(1:3)], dims = 3, perplexity = 25, 
  max_iter = 6000)

plotData <- data.frame(tsne_res$Y, MoA = tsne_mat$process_broad, 
  drug = paste0(tsne_mat$drugname_typaslab, "_", tsne_mat$conc))
colnames(plotData)[1:3] <- c("tSNE1", "tSNE2", "tSNE3")

p <- plot_ly(plotData, x = ~tSNE1, y = ~tSNE2, z = ~tSNE3, color = ~MoA, 
  colors = moa_cols[levels(tsne_mat$process_broad)], 
  marker = list(size = 8, line = list(color = 'rgba(0, 0, 0, 1)', 
    width = 1.5))) %>%
  add_markers(text = ~ drug) %>%
  layout(title = "tSNE map", 
    scene = list(xaxis = list(title = 'tSNE1'), yaxis = list(title = 'tSNE2'), 
      zaxis = list(title = 'tSNE3')))

library(gridExtra)
p1 <- ggplot(plotData, aes(x = tSNE1, y = tSNE2, colour = MoA)) + 
    geom_point(alpha = 0.75) + 
    scale_colour_manual("MoA", values = moa_cols, labels = moa_repl) + 
    poster_theme + 
    theme(legend.position = "None")

p2 <- ggplot(plotData, aes(x = tSNE1, y = tSNE3, colour = MoA)) + 
    geom_point(alpha = 0.75) + 
    scale_colour_manual("MoA", values = moa_cols, labels = moa_repl) + 
    poster_theme

grid.arrange(p1, p2, ncol = 2, widths = c(unit(78, "mm"), unit(122, "mm")), 
  heights = unit(110, "mm")) %T>% 
  ggsave(filename = "./plots/POSTER_tSNE.pdf")


## FOR PAPER
ggplot(plotData, aes(x = tSNE1, y = tSNE2, colour = MoA)) + 
  geom_point(alpha = 0.75, shape = 16) + 
  scale_colour_manual("MoA", values = moa_cols, labels = moa_repl) + 
  paper_theme + 
  theme(legend.position = "None")

ggsave(filename = "./plots/paper/tSNE1.pdf", width = 50, height = 50, 
  units = "mm")

ggplot(plotData, aes(x = tSNE1, y = tSNE3, colour = MoA)) + 
  geom_point(alpha = 0.75, shape = 16) + 
  scale_colour_manual("MoA", values = moa_cols, labels = moa_repl) + 
  paper_theme

ggsave(filename = "./plots/paper/tSNE2.pdf", width = 90, height = 50, 
  units = "mm")
```


Chemogenomic fingerprint, all drugs (training + Nichols + Lucia + unknown).

```{r}
select(m_all_alldrugs, drugname_typaslab, conc, process_broad, fingerprint_mcl) %>%
  plot_tsne(save = TRUE, file = "./data/programmatic_output/tSNE_fingerprint_alldrugs.rds")
```


## Hierarchical clustering

With fingerprint features, on the training set and on Nichols + Lucia + unknown 
drugs. 

```{r}
m_all <- readRDS("./data/programmatic_output/m_all.rds")
mode_of_action <- read_csv("./data/programmatic_output/drug_moa_userfriendly.csv")
mic_info <- read_delim("./data/programmatic_output/MICs.csv", delim = ";")

# all features, training set
if (!file.exists("./plots/Hclust_allfeats_training.pdf")) {
  plot_heatmap(dfm = m_all, feats = colnames(select(m_all, AAEX:last_col())), 
    mics = mic_info, split = 4, 
    moa = mode_of_action, save = TRUE, file = "./plots/Hclust_allfeats_training.pdf")
}

# fingerprint features, training set
plot_heatmap(dfm = m_all, feats = fingerprint_mcl, mics = mic_info, split = 4, 
  moa = mode_of_action, save = TRUE, file = "./plots/Hclust_fpt_training.pdf")

# fingerprint features, all drugs
plot_heatmap(dfm = m_all_alldrugs, feats = fingerprint_mcl, mics = mic_info, 
  split = 4, moa = mode_of_action, save = TRUE, file = "./plots/Hclust_fpt_alldrugs.pdf")
```

## PCA

Also with fingerprint features on both training set and "all" drugs. 

```{r}
# all features, training set
plot_pca(m_all, save = TRUE, file = "./plots/PCA_allfeats_training.pdf")

# fingerprint features, training set
select(m_all, drugname_typaslab, conc, process_broad, fingerprint_mcl) %>% 
  plot_pca(save = TRUE, file = "./plots/PCA_fpt_training.pdf")

# fingerprint features, all drugs
select(m_all_alldrugs, drugname_typaslab, conc, process_broad, fingerprint_mcl) %>% 
  plot_pca(save = TRUE, file = "./plots/PCA_fpt_alldrugs.pdf")
```



# Session info

```{r session_info}
R.version
sessionInfo()
```

